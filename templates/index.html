<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Click Trader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link 
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
      rel="stylesheet">
    <link 
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" 
      rel="stylesheet">
    <style>
        .status-open {
            color: #28a745;
            font-weight: bold;
        }
        .status-closed {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">Click Trader</h1>
        <div class="mb-4">
            <span class="h4">ASX Status: </span>
            <span class="h4 {% if asx_status == 'Open' %}status-open{% else %}status-closed{% endif %}">
                {{ asx_status }}
            </span>
            {% if asx_status == 'Closed' %}
            <div class="alert alert-warning mt-2">
                <i class="bi bi-exclamation-triangle"></i>
                ASX trading hours are 10:00 AM - 4:00 PM Sydney time, Monday to Friday.
                {% if asx_status == 'Closed' %}
                <br>Real trading orders will be placed when the market reopens.
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Form to add stock -->
        <div class="card mb-4">
            <div class="card-body">
                <form action="/" method="POST" class="row g-3">
                    <div class="col-md-4">
                        <select name="stock_symbol" id="stock_symbol" class="form-select" required>
                            <option value="" disabled selected>Select ASX Stock</option>
                            <option value="BHP">BHP Group (BHP)</option>
                            <option value="CBA">Commonwealth Bank (CBA)</option>
                            <option value="CSL">CSL Limited (CSL)</option>
                            <option value="NAB">National Australia Bank (NAB)</option>
                            <option value="ANZ">ANZ Banking Group (ANZ)</option>
                            <option value="WBC">Westpac Banking (WBC)</option>
                            <option value="WES">Wesfarmers (WES)</option>
                            <option value="WOW">Woolworths Group (WOW)</option>
                            <option value="WPL">Woodside Energy (WPL)</option>
                            <option value="RIO">Rio Tinto (RIO)</option>
                            <option value="TLS">Telstra (TLS)</option>
                            <option value="MQG">Macquarie Group (MQG)</option>
                            <option value="NCM">Newcrest Mining (NCM)</option>
                            <option value="GMG">Goodman Group (GMG)</option>
                        </select>
                        <div id="price-display" class="form-text mt-2"></div>
                    </div>
                    <div class="col-md-4">
                        <input type="number" name="investment_amount" class="form-control" placeholder="Investment Amount (AUD)" step="0.01" required>
                    </div>
                    <div class="col-md-2">
                        <select name="trading_type" class="form-select">
                            <option value="simulated" selected>Simulated</option>
                            <option value="real">Real Trading</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Add</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Portfolio list -->
        <div class="card">
            <div class="card-header">
                <strong>Simulated Portfolio</strong>
            </div>
            <ul class="list-group list-group-flush">
                {% for p in portfolios %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ p.portfolio.stock_symbol }}</strong>
                                <div class="text-muted small">
                                    Investment: ${{ "%.2f"|format(p.portfolio.investment_amount) }} ({{ p.portfolio.trading_type }})
                                </div>
                                <div class="text-muted small">
                                    Purchase Price: ${{ "%.2f"|format(p.portfolio.purchase_price) if p.portfolio.purchase_price else 'N/A' }}
                                    {% if p.current_price %}
                                        <br>Current Price: ${{ "%.2f"|format(p.current_price) }}
                                    {% endif %}
                                    {% if p.last_closed_price %}
                                        <br>Last Closed: ${{ "%.2f"|format(p.last_closed_price) }}
                                    {% endif %}
                                    {% if p.price_change is not none %}
                                        <br>Change: 
                                        <span class="{% if p.price_change > 0 %}text-success{% elif p.price_change < 0 %}text-danger{% endif %}">
                                            {{ "%.2f"|format(p.price_change) }}%
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <a href="/delete/{{ p.portfolio.id }}" class="btn btn-sm btn-outline-danger">Remove</a>
                        </div>
                    </li>
                {% else %}
                    <li class="list-group-item text-center text-muted">No stocks added yet.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</body>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const stockSelect = document.getElementById('stock_symbol');
        const priceDisplay = document.getElementById('price-display');
        stockSelect.addEventListener('change', function() {
            const symbol = this.value;
            if (symbol) {
                priceDisplay.textContent = 'Fetching price...';
                fetch(`/price/${symbol}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.price !== undefined) {
                            priceDisplay.textContent = `Latest Price: $${data.price.toFixed(2)} AUD`;
                        } else {
                            priceDisplay.textContent = 'Price not found.';
                        }
                    })
                    .catch(() => {
                        priceDisplay.textContent = 'Error fetching price.';
                    });
            } else {
                priceDisplay.textContent = '';
            }
        });
    });
</script>
</html>
